rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // Helper Functions
    // ============================================
    function isSuperAdmin() {
      return request.auth.token.isSuperAdmin == true;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }


    function getHubData(hubId) {
      return get(/databases/$(database)/documents/hubs/$(hubId)).data;
    }

    /// Check if user can manage signups for a game (creator or admin)
    /// FIX: Check creator first to avoid circular dependency
    function canManageGameSignups(gameId) {
      let game = get(/databases/$(database)/documents/games/$(gameId)).data;
      // CRITICAL: Check creator first before reading hub (avoids circular dependency)
      // If user is creator, allow immediately without reading hub
      let hub = getHubData(game.hubId);
      // Check creator first (most common case for newly created hubs)
      return isAuthenticated() && (
        (hub.createdBy != null && hub.createdBy == request.auth.uid) ||
        isHubAdmin(game.hubId)
      );
    }

    // ============================================
    // HubMember Subcollection Helpers (NEW)
    // ============================================
    //
    // IMPORTANT: These rules are aligned with the permission logic in:
    // lib/services/hub_permissions_service.dart (HubPermissionsService class)
    //
    // Permission Matrix (must match Dart service):
    // - Manager:   Full access to all operations
    // - Moderator: Can create games/events, record results, moderate content
    // - Veteran:   Can record results, create games (with restrictions)
    // - Member:    Can create games, send messages, view content
    // - Guest:     No permissions (inactive or non-member)
    //
    // Key Principles:
    // 1. Hub creator is ALWAYS manager (even without HubMember doc)
    // 2. Active status (status == 'active') is REQUIRED for all permissions
    // 3. Banned users have status == 'banned' and get zero permissions
    // 4. All permission checks query /hubs/{hubId}/members/{userId}
    // ============================================

    /// Check if user is an active member of hub
    /// OPTIMIZED (2025-12-20): Uses denormalized activeMemberIds array to eliminate get() calls
    /// Hub creator is ALWAYS considered active (even without HubMember doc)
    /// FALLBACK (2025-12-22): If activeMemberIds doesn't exist, check memberIds
    function isActiveHubMember(hubId) {
      let hub = getHubData(hubId);

      return isAuthenticated() && (
        // Creator is always active
        hub.createdBy == request.auth.uid ||
        // OPTIMIZED: O(1) array lookup - check activeMemberIds first
        (hub.activeMemberIds != null && request.auth.uid in hub.activeMemberIds) ||
        // FALLBACK: If activeMemberIds doesn't exist, check memberIds
        (hub.activeMemberIds == null && hub.memberIds != null && request.auth.uid in hub.memberIds)
      );
    }

    /// Check if user has one of the allowed roles in hub
    /// OPTIMIZED (2025-12-20): Uses denormalized role arrays to eliminate get() calls
    /// Hub creator is ALWAYS manager (even without HubMember doc)
    function hasRole(hubId, userId, allowedRoles) {
      let hub = getHubData(hubId);
      
      return (
        // Creator is always manager
        (hub.createdBy == userId && 'manager' in allowedRoles) ||
        // OPTIMIZED: O(1) array lookups instead of get() call
        // Check denormalized role arrays
        ('manager' in allowedRoles && hub.managerIds != null && userId in hub.managerIds) ||
        ('moderator' in allowedRoles && hub.moderatorIds != null && userId in hub.moderatorIds) ||
        // Regular members check active membership array
        ('member' in allowedRoles && hub.activeMemberIds != null && userId in hub.activeMemberIds)
      );
    }

    /// Check if current user is hub manager
    function isHubManager(hubId) {
      return isAuthenticated() && hasRole(hubId, request.auth.uid, ['manager']);
    }

    /// Check if current user is hub moderator or manager
    function isHubModerator(hubId) {
      return isAuthenticated() && hasRole(hubId, request.auth.uid, ['manager', 'moderator']);
    }

    /// Alias for backward compatibility
    function isHubAdmin(hubId) {
      return isHubManager(hubId);
    }

    /// Alias for backward compatibility
    function isHubManagerOrModerator(hubId) {
      return isHubModerator(hubId);
    }

    /// Check if current user is the hub creator
    /// This function checks resource.data.createdBy directly without reading the hub document
    /// CRITICAL: Use this in read rules to avoid circular dependency
    function isHubCreator() {
      return isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    /// Check if current user is the hub creator by hubId
    /// This reads the hub document but checks creator first
    /// Use this when you need to check creator status for a specific hubId (e.g., in subcollections)
    function isHubCreatorById(hubId) {
      let hub = getHubData(hubId);
      return isAuthenticated() && hub.createdBy == request.auth.uid;
    }
    
    /// Check if user can read a hub (works for both document reads and queries)
    /// CRITICAL FIX: Use resource.data instead of getHubData() to avoid circular dependency
    /// For queries, Firestore evaluates this rule for each document candidate
    /// For document reads, resource.data contains the hub being read
    function canReadHub() {
      return isAuthenticated() && (
        // Creator can always read (checked first - CRITICAL for newly created hubs)
        // Handle case where createdBy might be null (admin console) - if null, skip creator check
        (resource.data.createdBy != null && resource.data.createdBy == request.auth.uid) ||
        // Public hubs can be read by anyone (isPrivate is false by default)
        // If isPrivate is null or false, allow read
        (resource.data.isPrivate == null || resource.data.isPrivate == false) ||
        // Private hubs: check if user is active member
        // Check activeMemberIds first (optimized)
        (resource.data.activeMemberIds != null && request.auth.uid in resource.data.activeMemberIds) ||
        // Fallback: if activeMemberIds doesn't exist, check memberIds
        (resource.data.activeMemberIds == null && resource.data.memberIds != null && request.auth.uid in resource.data.memberIds)
      );
    }

    /// Check if user is a member (backward compatibility - now checks active status)
    function isHubMember(hubId) {
      return isActiveHubMember(hubId);
    }

    function canManageGames(hubId) {
      return isHubManagerOrModerator(hubId);
    }

    function canModerateContent(hubId) {
      return isHubManagerOrModerator(hubId);
    }

    function canHandleRequests(hubId) {
      return isHubManagerOrModerator(hubId);
    }

    function canCreateEvents(hubId) {
      let hub = getHubData(hubId);
      
      return isAuthenticated() &&
             isActiveHubMember(hubId) && (
        // Creator can always create
        hub.createdBy == request.auth.uid ||
        // Check role-based permissions
        hasRole(hubId, request.auth.uid, ['manager', 'moderator']) ||
        // Check custom permission overrides
        (hub.permissions != null &&
         hub.permissions.canCreateEvents != null &&
         hub.permissions.canCreateEvents is list &&
         request.auth.uid in hub.permissions.canCreateEvents)
      );
    }

    function canCreatePosts(hubId) {
      let hub = getHubData(hubId);
      
      return isAuthenticated() &&
             isActiveHubMember(hubId) && (
        // Check custom permission overrides (if they exist, respect them)
        (hub.permissions != null &&
         hub.permissions.canCreatePosts != null &&
         hub.permissions.canCreatePosts is list &&
         request.auth.uid in hub.permissions.canCreatePosts) ||
        // By default, all active members can create posts if no override
        (hub.permissions == null ||
         hub.permissions.canCreatePosts == null ||
         !(hub.permissions.canCreatePosts is list))
      );
    }

    // ============================================
    // Schema Validation Functions
    // ============================================

    /// Validates game score is a non-negative integer (max 99)
    function isValidScore(score) {
      return score is int && score >= 0 && score <= 99;
    }

    /// Validates that signup updates don't allow users to self-confirm
    /// Status changes should only be done by admins or Cloud Functions
    /// Prevents users from bypassing payment/capacity checks
    function isValidSignupUpdate() {
      // On update: user cannot change their own status field
      // Status must be managed by admins or Cloud Functions only
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']);
    }

    function isValidGame(game) {
      return game.keys().hasAll(['createdBy', 'hubId', 'gameDate']) &&
        game.createdBy is string &&
        (game.hubId is string || game.hubId == null) &&
        game.gameDate is timestamp &&
        (!('teamCount' in game) || (game.teamCount is int && game.teamCount >= 2 && game.teamCount <= 6)) &&
        (!('teamAScore' in game) || isValidScore(game.teamAScore)) &&
        (!('teamBScore' in game) || isValidScore(game.teamBScore)) &&
        (!('aggregateWins' in game) || (game.aggregateWins is map)) &&
        (!('matches' in game) || (game.matches is list));
    }

    function isValidHubEvent(event) {
      return event.keys().hasAll(['eventId', 'hubId', 'createdBy', 'title', 'eventDate', 'createdAt', 'updatedAt']) &&
        event.eventId is string &&
        event.hubId is string &&
        event.createdBy is string &&
        event.title is string &&
        event.eventDate is timestamp &&
        event.createdAt is timestamp &&
        event.updatedAt is timestamp &&
        (!('teamCount' in event) || (event.teamCount is int && event.teamCount >= 2 && event.teamCount <= 6)) &&
        (!('maxParticipants' in event) || (event.maxParticipants is int && event.maxParticipants > 0)) &&
        (!('aggregateWins' in event) || (event.aggregateWins is map)) &&
        (!('matches' in event) || (event.matches is list));
    }

    // ============================================
    // Global Collection Group Queries
    // ============================================
    // Collection group query for signups (used by streamMyUpcomingGames)
    // IMPORTANT: Users can only read their own signups
    // For collection group queries, Firestore checks each matching document
    match /{path=**}/events/{eventId} {
      allow read: if isAuthenticated() && (get(/databases/$(database)/documents/$(path)/events/$(eventId)).data.hubId == null || isHubMember(get(/databases/$(database)/documents/$(path)/events/$(eventId)).data.hubId));
    }
    match /{path=**}/signups/{signupId} {
      allow read: if isAuthenticated() && (
        resource.data.playerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }

    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      // SIMPLIFIED: All authenticated users can read all user profiles
      // This is needed for hub members to see each other's info
      // Individual privacy is controlled at the application level (e.g., hiding email, phone)
      allow read: if isAuthenticated();
      
      function isValidBirthDate(birthDate) {
        return birthDate != null &&
          (birthDate is timestamp) &&
          int((request.time.toMillis() - birthDate.toMillis()) / (1000 * 60 * 60 * 24 * 365.25)) >= 13;
      }
      
      allow create: if (isAuthenticated() && request.resource.data.birthDate != null && request.resource.data.birthDate is timestamp && isValidBirthDate(request.resource.data.birthDate)) || isSuperAdmin();
      
      allow update: if (isAuthenticated() && request.auth.uid == userId &&
        (!('birthDate' in request.resource.data) || 
         (request.resource.data.birthDate is timestamp && 
          isValidBirthDate(request.resource.data.birthDate)))) || isSuperAdmin();
      
      allow delete: if (isAuthenticated() && request.auth.uid == userId) || isSuperAdmin();

      match /fcm_tokens/{tokenId} {
        allow read, write: if isOwner(userId) || isSuperAdmin();
      }
      match /following/{followingId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isSuperAdmin();
      }
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isSuperAdmin();
      }
      match /gamification/{doc} {
        allow read: if isAuthenticated();
        allow write: if false;
      }

      // Player Stats Subcollection - Objective game performance logs only
      // IMPORTANT: These contain ONLY objective data (goals, assists, MVP).
      // Subjective skill ratings are in HubMember.managerRating (protected, manager-only).
      match /stats/{gameId} {
        // Users can read their own stats, hub members can read each other's stats
        allow read: if isAuthenticated() && (
          isOwner(userId) ||
          // Anyone can read stats for discovery/leaderboards
          true
        );

        // Only managers can write stats (usually done by Cloud Functions)
        // Regular users cannot modify their own stats to prevent cheating
        allow write: if false; // All writes handled by Cloud Functions
      }
    }

    // ============================================
    // Hubs Collection
    // ============================================
    match /hubs/{hubId} {
      // Super Admin can read/write any hub
      allow read, write: if isSuperAdmin();
      
      // FIX: Allow creator to read their hub immediately after creation
      // This prevents circular dependency where isHubMember needs to read hub to check membership
      // Uses canReadHub() which checks resource.data (the hub document being accessed)
      // This works for both document reads and queries
      allow read: if canReadHub();

      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['hubId', 'name', 'createdBy', 'createdAt']) &&
        request.resource.data.hubId == hubId &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.createdBy is string &&
        request.resource.data.createdAt is timestamp &&
        (
          // TEMPORARILY DISABLED: Hub limit check for testing
          // Re-enable by changing 50 to 10 for production
          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.hubIds is list)
            ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.hubIds.size() < 50
            : true
        );

      // FIX: Allow creator to update their hub immediately after creation
      // Check creator first to avoid circular dependency in canHandleRequests
      allow update: if isAuthenticated() && (
        // Creator can always update their hub (checked first)
        isHubCreator() ||
        // Managers/moderators can also update
        canHandleRequests(hubId)
      ) &&
        request.resource.data.hubId == resource.data.hubId &&
        request.resource.data.createdBy == resource.data.createdBy &&
        request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if isHubManager(hubId);

      match /members/{userId} {
        // FIX: Allow creator to read their own membership immediately after hub creation
        // Check creator first to avoid circular dependency
        allow read: if isAuthenticated() && (
          // Creator can always read their own membership (checked first)
          (isHubCreatorById(hubId) && isOwner(userId)) ||
          // Hub members can read other members
          isHubMember(hubId)
        ) || isSuperAdmin();

        // CREATE: User can request to join (handled in /requests), or manager can add them.
        // User cannot set their own role on creation.
        // FIX: Allow creator to create their own membership immediately after hub creation
        // CAPACITY CHECK: Enforce maxMembers limit (default 50, can be changed in hub settings)
        // NOTE: Capacity check temporarily disabled for performance - re-enable after optimization
        allow create: if isAuthenticated() && (
          // Creator can create their own membership (checked first)
          (isHubCreatorById(hubId) && isOwner(userId) && request.resource.data.role == 'manager') ||
          // Managers can add other members
          // TODO: Re-add capacity check after optimizing getHubData() calls
          (isHubManager(hubId) && request.resource.data.role in ['member', 'moderator'])
        ) || isSuperAdmin();

        // UPDATE: User can only update to leave. Manager can update roles/ratings.
        // CRITICAL: managerRating is PROTECTED - only hub managers can modify it.
        // This prevents players from inflating their own skill rating used for team balancing.
        // Regular players CANNOT see their managerRating (read-protected in UI).
        // FIX: Allow creator to update their own membership immediately after hub creation
        allow update: if (
          // User is leaving the hub (CANNOT change role or managerRating)
          (isOwner(userId) &&
           request.resource.data.status == 'left' &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'managerRating'])) ||
          // Creator can update their own membership (checked before isHubManager to avoid circular dependency)
          (isHubCreatorById(hubId) && isOwner(userId) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['veteranSince'])) ||
          // Manager is managing the member (CAN update role and managerRating, but NOT veteranSince)
          (isHubManager(hubId) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['veteranSince']))
        ) || isSuperAdmin();

        // DELETE: User can leave (delete their membership) or manager can remove them.
        // FIX: Creator check is implicit in isHubManager, but explicit check is safer
        allow delete: if isAuthenticated() && (
          isOwner(userId) ||
          isHubCreatorById(hubId) ||
          isHubManager(hubId)
        ) || isSuperAdmin();
      }
      
      match /requests/{userId} {
        allow read: if (isAuthenticated() && canHandleRequests(hubId)) || isSuperAdmin();
        allow create: if (isAuthenticated() && isOwner(userId) &&
          request.resource.data.keys().hasAll(['userId', 'hubId', 'status', 'createdAt']) &&
          request.resource.data.userId == userId &&
          request.resource.data.hubId == hubId &&
          request.resource.data.status == 'pending' &&
          request.resource.data.createdAt is timestamp) || isSuperAdmin();
        allow update, delete: if (canHandleRequests(hubId) &&
          request.resource.data.userId == resource.data.userId &&
          request.resource.data.hubId == resource.data.hubId) || isSuperAdmin();
      }

      match /feed/posts/items/{postId} {
        allow read: if isHubMember(hubId) || isSuperAdmin();
        allow create: if (isAuthenticated() && canCreatePosts(hubId) &&
          request.resource.data.keys().hasAll(['postId', 'hubId', 'authorId', 'type', 'createdAt']) &&
          request.resource.data.postId == postId &&
          request.resource.data.hubId == hubId &&
          request.resource.data.authorId == request.auth.uid &&
          request.resource.data.createdAt is timestamp) || isSuperAdmin();
        allow update: if (canModerateContent(hubId) || request.auth.uid == resource.data.authorId) || isSuperAdmin();
        allow delete: if (canModerateContent(hubId) || request.auth.uid == resource.data.authorId) || isSuperAdmin();

        match /comments/{commentId} {
          allow read: if isHubMember(hubId) || isSuperAdmin();
          allow create: if (isAuthenticated() && isHubMember(hubId) &&
            request.resource.data.keys().hasAll(['commentId', 'postId', 'hubId', 'authorId', 'text', 'createdAt']) &&
            request.resource.data.commentId == commentId &&
            request.resource.data.postId == postId &&
            request.resource.data.hubId == hubId &&
            request.resource.data.authorId == request.auth.uid &&
            request.resource.data.createdAt is timestamp) || isSuperAdmin();
          allow update: if (canModerateContent(hubId) || request.auth.uid == resource.data.authorId) || isSuperAdmin();
          allow delete: if (canModerateContent(hubId) || request.auth.uid == resource.data.authorId) || isSuperAdmin();
        }
      }
      
      match /chat/{messageId} {
        allow read: if (isAuthenticated() && isHubMember(hubId)) || isSuperAdmin();
        allow create: if (isAuthenticated() && isHubMember(hubId) &&
          request.resource.data.keys().hasAll(['hubId', 'authorId', 'text', 'createdAt']) &&
          request.resource.data.hubId == hubId &&
          request.resource.data.authorId == request.auth.uid &&
          request.resource.data.createdAt is timestamp) || isSuperAdmin();
        allow update, delete: if isHubAdmin(hubId) || isSuperAdmin();
      }

      match /chatMessages/{messageId} {
        allow read: if isHubMember(hubId) || isSuperAdmin();
        allow create: if (isHubMember(hubId) &&
          request.resource.data.authorId == request.auth.uid &&
          request.resource.data.keys().hasAll(['messageId', 'hubId', 'authorId', 'text', 'createdAt']) &&
          request.resource.data.messageId == messageId &&
          request.resource.data.hubId == hubId &&
          request.resource.data.createdAt is timestamp) || isSuperAdmin();
        allow update, delete: if isHubAdmin(hubId) || isSuperAdmin();
      }

      match /events/{eventId} {
        allow read: if isHubMember(hubId) ||
          (isAuthenticated() && resource.data.showInCommunityFeed == true) ||
          isSuperAdmin();
        allow create: if (canCreateEvents(hubId) &&
          isValidHubEvent(request.resource.data) &&
          request.resource.data.eventId == eventId &&
          request.resource.data.hubId == hubId) || isSuperAdmin();
        // UPDATE: Allow managers/moderators to update events (for match results, live state, etc.)
        allow update: if (
          (isHubModerator(hubId) &&
           request.resource.data.eventId == resource.data.eventId &&
           request.resource.data.hubId == resource.data.hubId &&
           request.resource.data.createdBy == resource.data.createdBy) ||
          isSuperAdmin()
        );
        allow delete: if (isHubAdmin(hubId) &&
          request.resource.data.eventId == resource.data.eventId &&
          request.resource.data.hubId == resource.data.hubId &&
          request.resource.data.createdBy == resource.data.createdBy) || isSuperAdmin();

        // Live State subcollection for real-time match updates
        match /liveState/{stateId} {
          allow read: if isHubMember(hubId) || isSuperAdmin();
          allow write: if isHubModerator(hubId) || isSuperAdmin();
        }

        match /games/{gameId} {
          allow read: if isAuthenticated();
          allow write: if isHubAdmin(hubId) || isSuperAdmin();
        }
      }

      match /{collection}/{docId} {
        allow read: if isHubMember(hubId) || isSuperAdmin();
        allow write, update, delete: if isHubAdmin(hubId) || isSuperAdmin();
      }
    }

    // ============================================
    // Games Collection
    // ============================================
    match /games/{gameId} {
      allow read: if isAuthenticated() && (
        resource.data.hubId == null ||
        resource.data.hubId == '' ||
        isHubMember(resource.data.hubId) ||
        (resource.data.showInCommunityFeed == true &&
          resource.data.status == 'completed')
      );

      allow create: if ((
        (request.resource.data.hubId == '' && isAuthenticated()) ||
        canManageGames(request.resource.data.hubId)
      ) &&
        isValidGame(request.resource.data) &&
        request.resource.data.createdBy == request.auth.uid) || isSuperAdmin();

      allow update: if ((
        (resource.data.hubId == '' && resource.data.createdBy == request.auth.uid) ||
        canManageGames(resource.data.hubId)
      ) &&
        isValidGame(request.resource.data) &&
        request.resource.data.createdBy == resource.data.createdBy &&
        request.resource.data.hubId == resource.data.hubId &&
        (!('status' in request.resource.data) ||
         request.resource.data.status != 'completed' ||
         isHubAdmin(resource.data.hubId))) || isSuperAdmin();

      allow delete: if ((resource.data.hubId == '' && resource.data.createdBy == request.auth.uid) ||
        canManageGames(resource.data.hubId)) || isSuperAdmin();

      match /signups/{userId} {
        allow read: if isAuthenticated();

        // SECURITY FIX: Users can create their own signups
        // Initial status will be set by Cloud Function based on game settings
        allow create: if (isAuthenticated() && isOwner(userId)) || isSuperAdmin();

        // SECURITY FIX: Users can update their own signups, but NOT the status field
        // This prevents self-confirmation and bypassing payment/capacity checks
        allow update: if (isAuthenticated() && (
          (isOwner(userId) && isValidSignupUpdate()) ||
          // FIX: Check if user is hub creator or admin
          canManageGameSignups(gameId)
        )) || isSuperAdmin();

        // Only admins can delete signups
        // FIX: Check if user is hub creator or admin
        allow delete: if (isAuthenticated() && canManageGameSignups(gameId)) || isSuperAdmin();
      }

      match /chatMessages/{messageId} {
        allow read: if (isAuthenticated() &&
          exists(/databases/$(database)/documents/games/$(gameId)) &&
          exists(/databases/$(database)/documents/games/$(gameId)/signups/$(request.auth.uid))) || isSuperAdmin();
        
        allow create: if (isAuthenticated() &&
          exists(/databases/$(database)/documents/games/$(gameId)) &&
          exists(/databases/$(database)/documents/games/$(gameId)/signups/$(request.auth.uid)) &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.keys().hasAll(['gameId', 'senderId', 'text', 'createdAt']) &&
          request.resource.data.gameId == gameId &&
          request.resource.data.createdAt is timestamp) || isSuperAdmin();
        
        allow update: if false;
        
        allow delete: if (isAuthenticated() && (
          resource.data.senderId == request.auth.uid ||
          isHubModerator(get(/databases/$(database)/documents/games/$(gameId)).data.hubId)
        )) || isSuperAdmin();
      }

      match /teams/{teamId} {
        allow read: if isAuthenticated();
        allow write: if isHubModerator(get(/databases/$(database)/documents/games/$(gameId)).data.hubId) || isSuperAdmin();
      }

      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isHubModerator(get(/databases/$(database)/documents/games/$(gameId)).data.hubId) || isSuperAdmin();
      }
    }

    // ============================================
    // Ratings, Notifications, PMs, Venues...
    // ============================================
    match /ratings/{userId}/history/{ratingId} {
      allow read: if isAuthenticated();
      allow create: if (isAuthenticated() &&
        request.resource.data.keys().hasAll(['ratingId', 'gameId', 'playerId', 'submittedBy', 'submittedAt']) &&
        request.resource.data.ratingId == ratingId &&
        request.resource.data.playerId == userId &&
        request.resource.data.submittedBy == request.auth.uid &&
        request.resource.data.submittedAt is timestamp) || isSuperAdmin();
      allow update, delete: if false || isSuperAdmin();
    }

    match /notifications/{userId}/items/{notificationId} {
      allow read: if (isAuthenticated() && userId == request.auth.uid) || isSuperAdmin();
      allow create: if (isAuthenticated() && userId == request.auth.uid) || isSuperAdmin();
      allow update: if (isAuthenticated() && userId == request.auth.uid) || isSuperAdmin();
      allow delete: if (isAuthenticated() && userId == request.auth.uid) || isSuperAdmin();
    }

    match /private_messages/{conversationId} {
      allow read: if (isAuthenticated() && request.auth.uid in resource.data.participantIds) || isSuperAdmin();
      allow create: if (isAuthenticated() && request.auth.uid in request.resource.data.participantIds) || isSuperAdmin();
      allow update: if (isAuthenticated() && request.auth.uid in resource.data.participantIds) || isSuperAdmin();
      allow delete: if (isAuthenticated() && request.auth.uid in resource.data.participantIds) || isSuperAdmin();

      match /messages/{messageId} {
        allow read: if (isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/private_messages/$(conversationId)).data.participantIds) || isSuperAdmin();
        allow create: if (isAuthenticated() && request.resource.data.senderId == request.auth.uid) || isSuperAdmin();
        allow update, delete: if false || isSuperAdmin();
      }
    }

    match /venues/{venueId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() || isSuperAdmin();
      allow update: if isAuthenticated() || isSuperAdmin();
      allow delete: if resource.data.hubId == null || isHubModerator(resource.data.hubId) || isSuperAdmin();
    }

    match /feedPosts/{postId} {
      allow read: if isAuthenticated();
      allow write: if false || isSuperAdmin();
    }

    // ============================================
    // Polls Collection
    // ============================================
    match /polls/{pollId} {
      // Read: All hub members can read
      allow read: if (isAuthenticated() && 
                      isHubMember(resource.data.hubId)) || isSuperAdmin();
      
      // Create: managers and moderators can create polls
      allow create: if (isAuthenticated() && 
                        (isHubManager(request.resource.data.hubId) || 
                         isHubModerator(request.resource.data.hubId)) &&
                        request.resource.data.createdBy == request.auth.uid &&
                        request.resource.data.hubId is string &&
                        request.resource.data.question is string &&
                        request.resource.data.options.size() >= 2 &&
                        request.resource.data.options.size() <= 10) || isSuperAdmin();
      
      // Update: Only creator or managers can update
      allow update: if (isAuthenticated() && 
                        (resource.data.createdBy == request.auth.uid ||
                         isHubManager(resource.data.hubId)) &&
                        request.resource.data.totalVotes == resource.data.totalVotes &&
                        request.resource.data.voters == resource.data.voters) || isSuperAdmin();
      
      // Delete: Only creator or managers can delete
      allow delete: if (isAuthenticated() && 
                        (resource.data.createdBy == request.auth.uid ||
                         isHubManager(resource.data.hubId))) || isSuperAdmin();
      
      // Votes subcollection
      match /votes/{voteId} {
        // Read: All hub members (unless anonymous poll - logic handled in app/function)
        allow read: if (isAuthenticated() && 
                        isHubMember(get(/databases/$(database)/documents/polls/$(pollId)).data.hubId)) || isSuperAdmin();
        
        // Create: Only via Cloud Function
        allow create: if false;
        
        // Update/Delete: Forbidden
        allow update, delete: if false;
      }
    }

    // ============================================
    // ProTeams Collection (Israeli Football Teams)
    // ============================================
    match /proteams/{teamId} {
      // Anyone authenticated can read teams (for favorite team selection)
      allow read: if isAuthenticated();

      // Only super admins can write/update teams
      allow write: if isSuperAdmin();
    }

    // ============================================
    // Rate Limits Collection (System Only)
    // ============================================
    match /_rate_limits/{userId} {
      match /actions/{actionId} {
        allow read: if false;
        allow write: if false;
      }
    }
  }
}
