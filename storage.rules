rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isHubManager(userId, hubId) {
      return get(/databases/(default)/documents/hubs/$(hubId)).data.createdBy == userId ||
        (get(/databases/(default)/documents/hubs/$(hubId)/members/$(userId)).exists &&
          get(/databases/(default)/documents/hubs/$(hubId)/members/$(userId)).data.role == 'manager' &&
          get(/databases/(default)/documents/hubs/$(hubId)/members/$(userId)).data.status == 'active');
    }

    // Profile photos: users/{uid}/*
    match /profile_photos/{userId}/{fileName} {
      // Anyone authenticated can read
      allow read: if request.auth != null;
      
      // Only owner can write
      allow write: if request.auth != null && 
        request.auth.uid == userId &&
        // Size limit: 5MB
        request.resource.size < 5 * 1024 * 1024 &&
        // Type check: only images
        request.resource.contentType.matches('image/.*');
    }
    
    // Hub photos: hubs/{hubId}/*
    match /hub_photos/{hubId}/{fileName} {
      // Anyone authenticated can read
      allow read: if request.auth != null;

      // Allow managers to delete (request.resource == null on delete)
      allow write: if request.resource == null &&
        request.auth != null &&
        isHubManager(request.auth.uid, hubId);

      // Only allow writes via signed URLs generated by a Cloud Function.
      // Direct writes are explicitly forbidden.
      allow write: if request.resource != null &&
        request.auth != null &&
        request.resource.size < 5 * 1024 * 1024 &&
        request.resource.contentType.matches('image/.*') && false;
    }
    
    // Game photos: games/{gameId}/*
    match /game_photos/{gameId}/{fileName} {
      // Anyone authenticated can read
      allow read: if request.auth != null;

      // Writes must go through signed URLs from a Cloud Function; direct writes are blocked.
      allow write: if request.auth != null &&
        request.resource.size < 5 * 1024 * 1024 &&
        request.resource.contentType.matches('image/.*') &&
        false;
    }

    // Hub feed photos: hubs/{hubId}/feed/photos/{fileName}
    match /hubs/{hubId}/feed/photos/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        request.resource.size < 5 * 1024 * 1024 &&
        request.resource.contentType.matches('image/.*');
    }
    
    // Resized images (read-only, created by Cloud Functions)
    match /{allPaths=**} {
      // Allow read if file contains _resized
      allow read: if request.auth != null && allPaths.matches('.*_resized.*');
      
      // Only Cloud Functions can write resized images
      allow write: if false;
    }
  }
}
