# מערכת הרשאות להאב (Hub Permissions System)

## סקירה כללית

מערכת ההרשאות להאב מגדירה את התפקידים וההרשאות של כל משתמש בהאב. המערכת תומכת ב-4 תפקידים עיקריים:

1. **מנהל Hub (Manager)** - יוצר ההאב, בעל הרשאות מלאות
2. **מנחה (Moderator)** - מונה על ידי המנהל, בעל הרשאות ניהול חלקיות
3. **שחקן ותיק (Veteran)** - שחקן שנמצא בהאב מעל חודשיים, בעל הרשאות מורחבות
4. **חבר (Member)** - שחקן רגיל בהאב

---

## תפקידים והרשאות

### 1. מנהל Hub (Manager)

**איך מתמנה:**
- יוצר ההאב אוטומטית הופך למנהל
- לא ניתן לשנות את התפקיד של יוצר ההאב

**הרשאות:**
- ✅ ניהול חברים (הוספה, הסרה, שינוי תפקידים)
- ✅ ניהול תפקידים (מינוי מנחים, שינוי תפקידים)
- ✅ ניהול הגדרות ההאב
- ✅ מחיקת ההאב
- ✅ יצירת משחקים
- ✅ יצירת אירועים
- ✅ ניהול תוכן (מחיקת פוסטים, תגובות)
- ✅ הזמנת שחקנים
- ✅ צפייה באנליטיקס
- ✅ עריכת פרטי ההאב

---

### 2. מנחה (Moderator)

**איך מתמנה:**
- מונה על ידי המנהל בלבד
- ניתן לשנות את התפקיד על ידי המנהל

**הרשאות:**
- ✅ ניהול חברים (הוספה, הסרה)
- ❌ ניהול תפקידים (רק המנהל יכול)
- ❌ ניהול הגדרות ההאב (רק המנהל יכול)
- ❌ מחיקת ההאב (רק המנהל יכול)
- ✅ יצירת משחקים
- ✅ יצירת אירועים
- ✅ ניהול תוכן (מחיקת פוסטים, תגובות)
- ✅ הזמנת שחקנים
- ✅ צפייה באנליטיקס
- ❌ עריכת פרטי ההאב (רק המנהל יכול)

---

### 3. שחקן ותיק (Veteran)

**איך מתמנה:**
- **אוטומטי** - כל שחקן שנמצא בהאב **מעל חודשיים (60 יום)** הופך אוטומטית לשחקן ותיק
- לא ניתן למנות שחקן ותיק ידנית
- אם שחקן ותיק מקבל תפקיד מפורש (moderator), הוא יאבד את סטטוס הותיקות

**הרשאות:**
- ❌ ניהול חברים (רק מנהל/מנחה)
- ❌ ניהול תפקידים (רק המנהל)
- ❌ ניהול הגדרות ההאב (רק המנהל)
- ❌ מחיקת ההאב (רק המנהל)
- ✅ יצירת משחקים
- ❌ יצירת אירועים (רק מנהל/מנחה)
- ❌ ניהול תוכן (רק מנהל/מנחה)
- ✅ הזמנת שחקנים
- ✅ צפייה באנליטיקס
- ❌ עריכת פרטי ההאב (רק המנהל)

**הערות:**
- שחקן ותיק יכול להזמין שחקנים חדשים להאב
- שחקן ותיק יכול לצפות באנליטיקס של ההאב (סטטיסטיקות, פעילות)
- שחקן ותיק יכול ליצור משחקים

---

### 4. חבר (Member)

**איך מתמנה:**
- כל שחקן שמצטרף להאב הופך אוטומטית לחבר
- אם שחקן נמצא בהאב פחות מחודשיים, הוא נשאר חבר

**הרשאות:**
- ❌ ניהול חברים (רק מנהל/מנחה)
- ❌ ניהול תפקידים (רק המנהל)
- ❌ ניהול הגדרות ההאב (רק המנהל)
- ❌ מחיקת ההאב (רק המנהל)
- ✅ יצירת משחקים
- ❌ יצירת אירועים (רק מנהל/מנחה)
- ❌ ניהול תוכן (רק מנהל/מנחה)
- ❌ הזמנת שחקנים (רק מנהל/מנחה/ותיק)
- ❌ צפייה באנליטיקס (רק מנהל/מנחה/ותיק)
- ❌ עריכת פרטי ההאב (רק המנהל)

### 5. אורח (Guest)

**איך מתמנה:**
- כל משתמש שאינו חבר בהאב

**הרשאות:**
- ❌ כל הפעולות (צפייה בלבד במידע ציבורי)

---

## מטריצת הרשאות

| פעולה | מנהל | מנחה | ותיק | חבר | אורח |
|------|------|------|------|------|------|
| ניהול חברים | ✅ | ✅ | ❌ | ❌ | ❌ |
| ניהול תפקידים | ✅ | ❌ | ❌ | ❌ | ❌ |
| ניהול הגדרות | ✅ | ❌ | ❌ | ❌ | ❌ |
| מחיקת האב | ✅ | ❌ | ❌ | ❌ | ❌ |
| יצירת משחקים | ✅ | ✅ | ✅ | ✅ | ❌ |
| יצירת אירועים | ✅ | ✅ | ❌ | ❌ | ❌ |
| ניהול תוכן | ✅ | ✅ | ❌ | ❌ | ❌ |
| הזמנת שחקנים | ✅ | ✅ | ✅ | ❌ | ❌ |
| צפייה באנליטיקס | ✅ | ✅ | ✅ | ❌ | ❌ |
| עריכת פרטי האב | ✅ | ❌ | ❌ | ❌ | ❌ |

---

## אכיפה (Enforcement)

המערכת אוכפת הרשאות בשתי רמות:

1. **צד הלקוח (Client-side):**
   - מחלקת `HubPermissions` בודקת הרשאות לפני הצגת כפתורים/מסכים.
   - מונעת פעולות לא מורשות ברמת ה-UI.

2. **צד השרת (Server-side - Firestore Rules):**
   - **Games:** יצירה מותרת לחברים בלבד. עריכה/מחיקה ליוצר או מנהל/מנחה.
   - **Hubs:** עריכת הגדרות/תפקידים מותרת למנהל בלבד.
   - **Feed:** מחיקת פוסטים/תגובות מותרת ליוצר או מנהל/מנחה.
   - **Venues:** יצירה/עריכה למנהל/מנחה.

---

## לוגיקה טכנית

### איך נקבע התפקיד?

התפקיד נקבע לפי סדר עדיפויות:

1. **יוצר ההאב** → תמיד `Manager`
2. **תפקיד מפורש ב-`roles`** → אם יש תפקיד מפורש, הוא משמש (חוץ מ-`member` שיכול להיות `veteran`)
3. **שחקן ותיק** → אם אין תפקיד מפורש והשחקן בהאב מעל 60 יום → `Veteran`
4. **חבר רגיל** → אם אין תפקיד מפורש והשחקן בהאב פחות מ-60 יום → `Member`

### איך נשמר תאריך ההצטרפות?

- כאשר שחקן מצטרף להאב, נשמר `memberJoinDates[userId] = Timestamp.now()`
- כאשר שחקן עוזב את ההאב, נמחק `memberJoinDates[userId]`
- אם אין תאריך הצטרפות (נתונים ישנים), משתמשים בתאריך יצירת ההאב כגיבוי

### איך נבדק אם שחקן הוא ותיק?

```dart
bool _isVeteranPlayer() {
  // 1. בדיקה אם השחקן חבר בהאב
  if (!hub.memberIds.contains(userId)) return false;
  
  // 2. קבלת תאריך ההצטרפות
  final joinDateTimestamp = hub.memberJoinDates[userId];
  
  // 3. אם אין תאריך, משתמשים בתאריך יצירת ההאב
  if (joinDateTimestamp == null) {
    final daysSinceHubCreation = DateTime.now().difference(hub.createdAt).inDays;
    return daysSinceHubCreation >= 60;
  }
  
  // 4. חישוב ימים מאז ההצטרפות
  final joinDate = joinDateTimestamp.toDate();
  final daysSinceJoin = DateTime.now().difference(joinDate).inDays;
  
  // 5. בדיקה אם מעל 60 יום
  return daysSinceJoin >= 60;
}
```

---

## שימוש בקוד

### בדיקת הרשאות

```dart
final hubPermissions = HubPermissions(hub: hub, userId: currentUserId);

// בדיקת תפקיד
if (hubPermissions.isManager()) {
  // מנהל
} else if (hubPermissions.isModerator()) {
  // מנחה
} else if (hubPermissions.isVeteran()) {
  // שחקן ותיק
} else if (hubPermissions.isMember()) {
  // חבר
}

// בדיקת הרשאות ספציפיות
if (hubPermissions.canCreateEvents()) {
  // יכול ליצור אירועים
}

if (hubPermissions.canInvitePlayers()) {
  // יכול להזמין שחקנים
}

if (hubPermissions.canViewAnalytics()) {
  // יכול לצפות באנליטיקס
}

// קבלת מידע נוסף
final joinDate = hubPermissions.getJoinDate();
final daysSinceJoin = hubPermissions.getDaysSinceJoin();
final roleName = hubPermissions.getRoleDisplayName();
```

### הוספת חבר להאב

```dart
final hubsRepo = ref.read(hubsRepositoryProvider);
await hubsRepo.addMember(hubId, userId);
// תאריך ההצטרפות נשמר אוטומטית
```

### הסרת חבר מהאב

```dart
final hubsRepo = ref.read(hubsRepositoryProvider);
await hubsRepo.removeMember(hubId, userId);
// תאריך ההצטרפות נמחק אוטומטית
```

---

## הערות חשובות

1. **תאריך הצטרפות**: תאריך ההצטרפות נשמר אוטומטית כאשר שחקן מצטרף להאב
2. **נתונים ישנים**: אם אין תאריך הצטרפות (נתונים ישנים), המערכת משתמשת בתאריך יצירת ההאב כגיבוי
3. **תפקיד מפורש**: אם יש תפקיד מפורש ב-`roles`, הוא תמיד גובר על סטטוס הותיקות
4. **יוצר ההאב**: יוצר ההאב תמיד נשאר מנהל, גם אם מנסים לשנות את התפקיד
5. **מנחה**: מנחה לא יכול להיות ותיק - התפקיד המפורש גובר

---

## דוגמאות שימוש

### דוגמה 1: בדיקת הרשאה לפני יצירת אירוע

```dart
final hubPermissions = HubPermissions(hub: hub, userId: currentUserId);

if (!hubPermissions.canCreateEvents()) {
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(content: Text('רק מנהל או מנחה יכולים ליצור אירועים')),
  );
  return;
}

// יצירת האירוע...
```

### דוגמה 2: הצגת כפתור הזמנה רק לבעלי הרשאה

```dart
final hubPermissions = HubPermissions(hub: hub, userId: currentUserId);

if (hubPermissions.canInvitePlayers()) {
  ElevatedButton(
    onPressed: () => _invitePlayer(),
    child: const Text('הזמן שחקן'),
  );
}
```

### דוגמה 3: הצגת תפקיד המשתמש

```dart
final hubPermissions = HubPermissions(hub: hub, userId: currentUserId);

Text('תפקיד: ${hubPermissions.getRoleDisplayName()}');

if (hubPermissions.isVeteran()) {
  final daysSinceJoin = hubPermissions.getDaysSinceJoin();
  Text('בהאב כבר $daysSinceJoin ימים');
}
```

---

## עדכונים עתידיים

- [ ] הוספת הרשאות נוספות לשחקנים ותיקים
- [ ] אפשרות למנהל להגדיר תקופת ותיקות מותאמת אישית
- [ ] היסטוריית שינויי תפקידים
- [ ] התראות אוטומטיות כאשר שחקן הופך לותיק

